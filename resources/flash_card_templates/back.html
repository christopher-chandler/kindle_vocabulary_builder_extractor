<div class="migaku-header">
    <svg class="migaku-logo" width="30" height="39" viewBox="0 0 30 39">
        <path fill-rule="evenodd" clip-rule="evenodd"
            d="M17.9 25.2947L18.1295 25.4774L18.6805 25.2947H18.956C19.0019 26.254 18.6346 27.2134 17.9918 27.8986C17.6981 28.2537 17.4067 28.6004 17.1201 28.9415C14.4933 32.0665 12.2661 34.7162 12.3903 39C12.3903 39 12.0689 37.2639 11.6557 35.1624C11.4433 34.5836 11.2718 33.9548 11.1 33.3253C10.4178 30.8245 9.73192 28.3106 6.46745 28.858C2.74843 29.3606 0.820054 28.4925 2.10563 25.249C0.661644 23.8747 1.51409 23.5681 2.03641 23.3803C2.27805 23.2934 2.44904 23.2319 2.28929 23.1018C0.178468 22.2675 0.981282 21.3969 1.54393 20.7868C1.87469 20.4281 2.12245 20.1594 1.6465 20.041C-0.235963 19.6298 -0.557358 18.7162 0.957793 17.2543C1.11403 17.0914 1.28714 16.9202 1.46697 16.7423C2.39695 15.8223 3.50664 14.7245 3.39122 13.6909C3.48305 12.3204 3.80444 10.9499 4.2636 9.62504C4.2636 9.53369 4.2636 9.4423 4.3095 9.35095C4.99822 7.66066 5.91649 6.10738 7.11022 4.69118C10.4619 0.396898 16.293 -1.15636 21.3894 0.89942H21.068V1.31058C21.068 1.76741 18.8182 2.90952 18.8182 2.90952L18.8641 2.95517H18.9559V3.00085H18.91L18.91 3.00088H18.8182L18.7723 3.04656L18.6805 3.00088H18.6346L18.5427 2.9552H18.6346L18.6805 2.90952L18.4968 2.86383L18.405 2.90952L18.4509 2.86383H18.3591H18.3132V2.81815L18.2673 2.86383H18.2673H18.1754L18.0836 2.9552H17.9459L17.9918 3.00088L17.9 2.9552L17.8081 3.00088V2.9552L17.7622 3.00088H17.6704L17.7163 3.04656L17.5786 3.00088L17.5327 3.09225H17.4408H17.3949H17.349H17.3031L17.3949 3.13794L17.2572 3.2293H17.2113L17.1194 3.27499H17.0735L17.1194 3.32067H17.0735L16.9817 3.41204H17.0735L16.8898 3.45772L16.9358 3.50341H16.844H16.8439V3.45772L16.6603 3.59477H16.5225V3.68614L16.3848 3.64046L16.4766 3.68614H16.3848H16.2471L16.2011 3.73183H16.1552H16.0634V3.82319H16.1093H16.1552L16.0634 3.86887H16.1552H16.2011L16.293 3.91458L16.3389 3.86887V3.96025L16.2471 4.00593L16.2011 3.96025H16.1093L16.0175 4.00593V4.05161L16.0634 4.00593V4.07118L15.9716 4.09728L16.006 4.13157L15.9716 4.14299H16.0175H16.1093L16.0634 4.18867L16.1552 4.23435H16.3389L16.5225 4.09728H16.6144L16.6603 3.91458L16.7062 4.14299H16.798L16.7521 4.23435L16.8898 4.41709L16.798 4.46276L16.8439 4.59983H17.0276L17.1194 4.50844H17.3031L17.4408 4.32573V4.18867H17.3949L17.5786 4.14299V4.09728L17.6245 4.14299L17.7163 4.09728H17.6245L17.7622 4.00593L17.6245 3.91458H17.5327L17.5786 3.64046L17.6245 3.68614L17.854 3.59477H17.9L18.1295 3.50341L18.0377 3.41204H18.1295V3.36635L18.2213 3.41204V3.36635H18.405L18.5427 3.41204L18.0836 3.68614L18.1754 3.82319L18.1295 3.96025L18.2673 4.00593H18.3591V4.05161L19.0019 4.00593V4.05161L19.2315 4.09728H18.956V4.18867L18.6346 4.14299L18.3591 4.18867L18.4509 4.32573H18.5427V4.50844L18.4509 4.55415L18.2673 4.41709H18.1754L18.0836 4.55415V4.78257H17.9918H17.9V4.82824L17.8081 4.87392L17.854 4.82824L17.7163 4.87392L17.5786 4.78257L17.0735 4.91959V4.96531L16.8439 4.82824L16.5225 4.87392L16.5684 4.82824H16.4307L16.3389 4.73689L16.3848 4.59983L16.6144 4.50844L16.5225 4.46276L16.6144 4.32573L16.293 4.41709L16.2011 4.78257H16.2471L16.293 4.82824H16.2011L16.3848 4.91959L16.2011 4.87392L16.1552 4.96531L16.1093 4.91959H15.9716L16.0175 4.96531H15.7879L15.6961 5.01098H15.6502L15.5584 5.05666L15.5124 4.96531L15.3747 5.10233L15.4665 5.14805H15.2829L15.4206 5.19372L14.9615 5.28507V5.37646L14.9156 5.42214L14.686 5.5592L14.3646 5.46781L14.4105 5.69623H14.1809L14.135 5.65055L13.8595 5.69623L13.9514 5.7419H13.8595V5.83329L14.135 5.87897L14.1809 6.06171H14.3187L14.2728 6.19877V6.24445L14.0432 6.60993H13.079L12.9872 6.56421L12.6658 6.70128L12.7117 6.83834L12.4821 7.29517L12.2526 7.56927L12.3903 7.52359L12.2985 7.66066H12.3444L12.2526 7.93475L12.6658 7.88907L12.8495 8.16316L13.1249 8.02614H13.5841L13.7677 7.8434H13.9973L14.0432 7.70633L14.135 7.66066L14.1809 7.61498L14.135 7.56927L14.0891 7.52359L14.135 7.43224L14.1809 7.38656L14.3646 7.20382L14.8237 7.02108V6.83834L14.9156 6.74696L15.0533 6.70128L15.4206 6.79267L15.9716 6.51854L16.2011 6.60993L16.3389 6.9297L17.2113 7.38656L17.3031 7.61498L17.2113 7.79772H17.3031L17.4408 7.61498L17.5327 7.56927L17.3949 7.43224L17.4867 7.29517H17.6704L17.854 7.43224L17.9 7.38656L17.3949 7.11243L17.4408 7.02108L17.1653 6.97541L16.9358 6.70128L16.7062 6.56421L16.6603 6.3358L16.9358 6.29012L16.9817 6.47286L17.1194 6.38151L17.349 6.74696H17.5327L17.6532 6.82692L17.854 6.88402L17.9918 7.02108L17.9459 7.29517L18.1295 7.38656L18.2673 7.52359H18.3591L18.2673 7.56927L18.3591 7.66066L18.607 7.68806L18.5427 7.66066L18.6346 7.61498V7.52359L18.7264 7.56927L18.5427 7.29517L18.6346 7.2495L18.8641 7.38656L18.8182 7.29517L18.956 7.34085L18.8182 7.20382L19.1855 7.15811L19.507 7.20382L19.4151 7.29517L19.3233 7.38656V7.47791H19.507L19.461 7.66066L19.5529 7.70633H19.461L19.4151 7.66066L19.3692 7.75201L19.5988 7.79772L19.5529 7.8434L19.6906 7.93475L19.6447 7.98042H19.8743L19.6906 8.07181L19.9202 8.02614L20.1956 8.16316H20.3334V8.02614H20.4252L20.7925 8.20888L21.0221 8.11749L21.1139 8.02614H21.3435L21.4812 7.98042V8.20888L21.5731 8.43729L21.2976 9.12254L20.9302 9.16821H20.8384L20.7925 9.07686H20.6089L20.1956 9.2596L19.7365 9.12254H19.3233L19.2315 9.03115L18.8641 8.98547L18.8182 8.89412L18.4968 8.84845L18.1295 9.03115V9.30528L17.9 9.44234L17.6704 9.30528L17.2113 9.16821L17.0735 8.9398L16.6603 8.84845H16.4307L15.9716 8.66571L15.9257 8.57432L16.2011 8.3459L16.0634 8.16316L16.2471 7.98042L16.1093 8.07181L15.9716 7.93475L15.6043 8.02614L15.2829 7.98042L15.0533 8.07181L14.7778 8.02614L14.1809 8.11749L13.9514 8.25455L13.7677 8.30023L13.5382 8.43729H13.3545V8.3459L12.9872 8.39158L12.8495 8.25455L12.7576 8.30023L12.4821 8.66571L11.8853 8.98547L11.7016 9.2596L11.6557 9.53369L11.518 9.71643L11.1966 9.94485L10.9211 9.99053L10.6915 10.2647L10.5078 10.356L10.3242 10.7215L10.0946 10.9042L9.72733 11.4067L9.65385 11.5895L9.72733 11.7722L9.63548 12.0006L9.68138 12.4118L9.45183 12.9143L9.22227 13.1427L9.40592 13.3712V13.5082L9.58958 13.9193L9.72733 13.9651L9.58958 14.0107L9.63548 14.1021L9.68138 14.0564L9.72733 14.2848L9.81914 14.3305L9.91098 14.3762L9.86504 14.4676L9.95688 14.5132V14.7417H10.0487L9.95688 14.7874L10.1405 14.9701V15.0615L10.4619 15.1985L11.0129 15.701L11.2884 15.8381L11.6098 15.6554L12.1148 15.564L12.574 15.7467L13.079 15.5183L13.4922 15.3812L14.0891 15.2442L13.9973 15.3356H14.2268L14.3187 15.3812L14.4105 15.3356L14.3187 15.4269L14.3646 15.4726L14.4564 15.4269L14.3646 15.5183L14.5023 15.7467H14.686V15.6554L14.7319 15.7467V15.6554L14.7778 15.7467L14.8237 15.6554L14.9156 15.7467H15.1451V15.6554L15.237 15.7924L15.3288 15.701L15.4206 15.8838L15.5584 15.8381L15.6043 15.9294H15.5584L15.6043 16.1122L15.4206 16.6147H15.5124V16.7974H15.4665H15.4206L15.463 16.8185L15.4206 17.0716H15.3288L15.5584 17.5284L16.1093 18.0309L16.2471 18.3507L16.3848 18.4421L16.2471 18.4878L16.5684 19.0816L16.4766 19.2644L16.5684 19.4928L16.6603 19.7669L16.6144 20.0867L16.3389 20.4065L16.1552 21.0004V21.5486L16.8439 22.645L16.9817 23.5587L17.5327 24.381L17.7622 24.7465V24.9292L17.6704 25.0205L17.8081 25.3404L17.9 25.2947ZM15.4818 16.8279L15.463 16.8185L15.4665 16.7974L15.4818 16.8279ZM15.4818 16.8279L15.6043 16.8888H15.5124L15.4818 16.8279ZM20.7073 6.19223L20.8384 6.29012H21.0221L20.6548 6.47286L20.517 6.42719L20.4252 6.29012H20.3334L20.517 6.24445L20.4711 6.19877H20.1497L20.1956 6.15306L20.1038 6.10738H20.2875L20.1956 6.06171L20.012 6.10738V6.19877L19.9202 6.29012L19.8743 6.24445L19.9202 6.42719L19.7365 6.47286L19.6906 6.38151V6.6556L19.507 6.83834H19.5988L19.9202 7.11243H19.6447L19.4151 7.29517H19.8743V7.2495H19.9202L19.8743 7.15811L20.2875 7.20382L20.6548 7.02108H20.9762L21.2976 7.20382L21.6649 7.2495H22.0322L22.2158 7.15811L22.2618 7.06676L22.0322 6.88402L21.7108 6.74696L21.068 6.38151L21.2057 6.3358L21.2496 6.16138L21.3435 6.19877L21.2517 6.15306L21.2496 6.16138L21.1139 6.10738H21.2517L21.3435 6.01603L20.7925 6.10738L20.7073 6.19223ZM20.7007 6.19873L20.7073 6.19223L20.7007 6.18732V6.10738L20.6793 6.17133L20.6548 6.15306L20.6777 6.1759L20.6548 6.24445L20.7466 6.3358H20.8384L20.7007 6.19877V6.19873ZM20.7007 6.19873V6.18732L20.6793 6.17133L20.6777 6.1759L20.7007 6.19873ZM16.0175 4.14299L16.1093 4.09728L16.006 4.13157L16.0175 4.14299ZM16.0634 4.07118L16.293 4.00593L16.0634 4.09728V4.07118ZM16.844 3.50341L16.7982 3.59476L16.6604 3.64044V3.59476H16.7522L16.844 3.50341ZM18.7356 7.74289L18.7264 7.75201L18.405 7.70633L18.3591 7.79772L18.4509 8.02614L18.5427 7.98042L18.6346 8.11749V8.02614L18.7723 8.11749L18.6346 7.88907H18.8182L18.7264 7.79772L18.79 7.76608L18.7356 7.74289ZM18.8285 7.7825L18.8641 7.88907V7.79772L18.8285 7.7825ZM19.2776 3.32066L19.2317 3.22929H19.0022L19.2317 3.27497H19.1858L19.2776 3.32066ZM29.1486 11.9092V11.6808L29.0568 11.5438V11.4524H29.0109L28.965 11.361L29.0109 11.3153H28.919L28.965 11.5894L28.8272 11.6808L28.414 11.2697L28.5977 11.224V11.1326L28.414 11.1783L28.2304 10.9956V10.9042L28.1844 10.9499V10.8585H28.1385L28.0926 10.8128V10.8585H28.0467L27.9549 10.6758H27.863L27.7712 10.493L27.0366 10.6301L26.7611 10.5387L26.2561 10.4474L26.0265 10.0819L25.7051 10.2646L25.4755 10.2189L25.2 10.0362L24.9705 9.99052L24.6031 9.53365L24.5572 9.48798L24.4654 9.53365L24.3277 9.39662V9.48798H24.144L24.2358 9.57936L24.144 9.62504H24.2358L24.5113 10.0362L24.8327 10.2646V10.4017L25.0623 10.6758L25.0164 10.4017H25.1541L25.2 10.7671L25.3837 10.8585L25.4755 10.8128H25.7051L26.0265 10.3103V10.493L26.1642 10.7671L26.302 10.9042L26.6234 10.9956L26.8988 11.3153L26.7611 11.7722L26.7152 11.7265L26.6234 11.7722L26.6693 12.092L26.4856 12.1376V12.3204L26.302 12.3661L26.2561 12.5488L25.7969 12.6859L25.751 12.9143L25.4296 13.0513H23.7308V13.0056L23.6849 12.6402L23.1798 11.8636L22.9962 11.6808L22.8125 11.4981L22.7207 11.1783L22.537 10.8585L22.3075 10.7214L22.2156 10.5387L21.6647 9.85346H21.527L21.5729 9.53365L21.481 9.94481L21.2515 9.76211L21.0219 9.4423L21.0678 9.62504L21.2974 9.89913L21.7565 10.6758L21.9402 10.8128H21.8943L21.9861 11.0412L22.3075 11.2697L22.4452 11.4981L22.3993 11.4524L22.4911 12.0463L22.8125 12.229L23.1798 12.96V12.8686L23.2257 12.9143L23.2716 13.0056L23.5012 13.097L24.0522 13.6452L24.0981 13.7366L23.9145 13.8737H24.0522L24.4195 14.1934L24.695 14.0564L24.8327 14.1021L25.0164 14.0107L25.4755 13.965L25.751 13.7823L25.8888 13.8279V14.1934H25.9806L25.7051 14.2848V14.3762V14.5132L25.3378 15.3355C25.5673 15.1985 25.7051 15.2442 25.7969 15.7467C25.9045 16.4156 25.7758 16.9905 25.6599 17.5081C25.5779 17.8742 25.5024 18.2117 25.5214 18.5334C25.5433 18.9028 25.347 19.2205 25.1796 19.4915C24.995 19.7902 24.8456 20.0321 25.0623 20.2237C25.2459 20.4064 25.5673 20.4978 25.8428 20.3608L25.9347 20.2694C25.8888 20.178 26.2101 19.7212 26.3938 19.7669C27.1743 18.7618 27.8171 17.6654 28.2763 16.4776V16.706C28.2763 16.9345 28.2304 17.1629 28.1844 17.3913C28.1385 17.5284 28.2304 17.7111 28.3681 17.7568C28.5058 17.8025 28.6895 17.7111 28.7354 17.5741C29.2404 16.2035 29.5159 14.7873 29.5159 13.3254V12.7772L29.1486 11.9092Z"
            fill="white" />
    </svg>
</div>

<div class="migaku-card migaku-card-back">

<br>

<div style='font-family: "Arial";
text-align: right; margin-right: 30px; font-size: 20px;'>{{Tags}}</div>

    <div class="migaku-card-screenshot">
        {{editable:Screenshot}}
    </div>

    <div class="migaku-card-content">
        <div class="migaku-card-sentence-audio">
            {{editable:Sentence Audio}}
        </div>
        <div class="migaku-card-sentence">
            <div class="field" data-popup="yes" data-furigana="no" data-pitch-coloring="yes" data-pitch-shapes="yes">{{editable:usage}}</div>
        </div>

        <div class="migaku-card-translation">

        </div>
        {{#usage}}

            <hr class="sentence-separator">
					<div class="field" data-popup="yes" data-furigana="yes" data-pitch-coloring="yes" data-pitch-shapes="yes">
        {{/usage}}
        <div class="migaku-card-unknown-audio migaku-indented">
            {{editable:Word Audio}}
        </div>
        <div class="migaku-card-unknown migaku-indented">
            <div class="field" data-popup="yes" data-furigana="yes" data-pitch-coloring="yes" data-pitch-shapes="yes">{{editable:word_key}}</div>
        </div>

        <div class="migaku-card-examples migaku-indented">
            <div class="field" data-popup="yes" data-furigana="yes" data-pitch-coloring="yes" data-pitch-shapes="yes">{{editable:Example Sentences}}</div>
        </div>
        <div class="migaku-card-definitions migaku-indented">
            <div class="field" data-popup="yes" data-furigana="yes" data-pitch-coloring="no" data-pitch-shapes="no">{{editable:Definitions}}</div>
        </div>
        <div class="migaku-card-images">
            {{editable:Images}}
        </div>
    </div>
</div>


<div class="migaku-typeselect">
    <form>
        <label>
            <input type="radio" id="type-s" name="type" value="s">
            Sentence
        </label>

        <label>
            <input type="radio" id="type-v" name="type" value="v">
            Vocabulary
        </label>

        <label>
            <input type="radio" id="type-as" name="type" value="as">
            Audio Sentence
        </label>

        <label>
            <input type="radio" id="type-av" name="type" value="av">
            Audio Vocabulary
        </label>
    </form>
</div>

<script>
    if (typeof (pycmd) !== "undefined") {
        const form = document.querySelector('.migaku-typeselect form');

        let card_type = `{{Is Vocabulary Card}}`.replace(/(<([^>]+)>)/ig, '').length ? 'v' : 's';
        if (`{{Is Audio Card}}`.replace(/(<([^>]+)>)/ig, '').length) {
            card_type = 'a' + card_type;
        }
        form.elements["type"].value = card_type;

        form.onchange = function () {
            const card_type = form.elements['type'].value;
            pycmd('update_card_type|' + card_type);
        }
    }
    else {
        document.querySelector('.migaku-typeselect').style.display = 'none';
    }
</script>

<!--###MIGAKU JAPANESE SUPPORT JS STARTS###--><script>
(function() {

//// YOMICHAN START ////

const KATAKANA_SMALL_KA_CODE_POINT = 0x30f5;
const KATAKANA_SMALL_KE_CODE_POINT = 0x30f6;
const KANA_PROLONGED_SOUND_MARK_CODE_POINT = 0x30fc;

const HIRAGANA_RANGE = [0x3040, 0x309f];
const KATAKANA_RANGE = [0x30a0, 0x30ff];

const HIRAGANA_CONVERSION_RANGE = [0x3041, 0x3096];
const KATAKANA_CONVERSION_RANGE = [0x30a1, 0x30f6];

const KANA_RANGES = [HIRAGANA_RANGE, KATAKANA_RANGE];

const VOWEL_TO_KANA_MAPPING = new Map([
    ['a', 'ぁあかがさざただなはばぱまゃやらゎわヵァアカガサザタダナハバパマャヤラヮワヵヷ'],
    ['i', 'ぃいきぎしじちぢにひびぴみりゐィイキギシジチヂニヒビピミリヰヸ'],
    ['u', 'ぅうくぐすずっつづぬふぶぷむゅゆるゥウクグスズッツヅヌフブプムュユルヴ'],
    ['e', 'ぇえけげせぜてでねへべぺめれゑヶェエケゲセゼテデネヘベペメレヱヶヹ'],
    ['o', 'ぉおこごそぞとどのほぼぽもょよろをォオコゴソゾトドノホボポモョヨロヲヺ'],
    ['', 'のノ']
]);

const KANA_TO_VOWEL_MAPPING = (() => {
    const map = new Map();
    for (const [vowel, characters] of VOWEL_TO_KANA_MAPPING) {
        for (const character of characters) {
            map.set(character, vowel);
        }
    }
    return map;
})();

function getProlongedHiragana(previousCharacter) {
    switch (KANA_TO_VOWEL_MAPPING.get(previousCharacter)) {
        case 'a': return 'あ';
        case 'i': return 'い';
        case 'u': return 'う';
        case 'e': return 'え';
        case 'o': return 'う';
        default: return null;
    }
}

function isCodePointInRange(codePoint, [min, max]) {
    return (codePoint >= min && codePoint <= max);
}

function isCodePointInRanges(codePoint, ranges) {
    for (const [min, max] of ranges) {
        if (codePoint >= min && codePoint <= max) {
            return true;
        }
    }
    return false;
}

function isCodePointKana(codePoint) {
    return isCodePointInRanges(codePoint, KANA_RANGES);
}

function convertKatakanaToHiragana(text, keepProlongedSoundMarks = false) {
    let result = '';
    const offset = (HIRAGANA_CONVERSION_RANGE[0] - KATAKANA_CONVERSION_RANGE[0]);
    for (let char of text) {
        const codePoint = char.codePointAt(0);
        switch (codePoint) {
            case KATAKANA_SMALL_KA_CODE_POINT:
            case KATAKANA_SMALL_KE_CODE_POINT:
                // No change
                break;
            case KANA_PROLONGED_SOUND_MARK_CODE_POINT:
                if (!keepProlongedSoundMarks && result.length > 0) {
                    const char2 = getProlongedHiragana(result[result.length - 1]);
                    if (char2 !== null) { char = char2; }
                }
                break;
            default:
                if (isCodePointInRange(codePoint, KATAKANA_CONVERSION_RANGE)) {
                    char = String.fromCodePoint(codePoint + offset);
                }
                break;
        }
        result += char;
    }
    return result;
}

function createFuriganaSegment(text, reading) {
    return { text, reading };
}

function getFuriganaKanaSegments(text, reading) {
    const textLength = text.length;
    const newSegments = [];
    let start = 0;
    let state = (reading[0] === text[0]);
    for (let i = 1; i < textLength; ++i) {
        const newState = (reading[i] === text[i]);
        if (state === newState) { continue; }
        newSegments.push(createFuriganaSegment(text.substring(start, i), state ? '' : reading.substring(start, i)));
        state = newState;
        start = i;
    }
    newSegments.push(createFuriganaSegment(text.substring(start, textLength), state ? '' : reading.substring(start, textLength)));
    return newSegments;
}

function segmentizeFurigana(reading, readingNormalized, groups, groupsStart) {
    const groupCount = groups.length - groupsStart;
    if (groupCount <= 0) {
        return reading.length === 0 ? [] : null;
    }

    const group = groups[groupsStart];
    const { isKana, text } = group;
    const textLength = text.length;
    if (isKana) {
        const { textNormalized } = group;
        if (readingNormalized.startsWith(textNormalized)) {
            const segments = segmentizeFurigana(
                reading.substring(textLength),
                readingNormalized.substring(textLength),
                groups,
                groupsStart + 1
            );
            if (segments !== null) {
                if (reading.startsWith(text)) {
                    segments.unshift(createFuriganaSegment(text, ''));
                } else {
                    segments.unshift(...getFuriganaKanaSegments(text, reading));
                }
                return segments;
            }
        }
        return null;
    } else {
        let result = null;
        for (let i = reading.length; i >= textLength; --i) {
            const segments = segmentizeFurigana(
                reading.substring(i),
                readingNormalized.substring(i),
                groups,
                groupsStart + 1
            );
            if (segments !== null) {
                if (result !== null) {
                    // More than one way to segmentize the tail; mark as ambiguous
                    return null;
                }
                const segmentReading = reading.substring(0, i);
                segments.unshift(createFuriganaSegment(text, segmentReading));
                result = segments;
            }
            // There is only one way to segmentize the last non-kana group
            if (groupCount === 1) {
                break;
            }
        }
        return result;
    }
}

function distributeFurigana(term, reading) {
    if (reading === term) {
        // Same
        return [createFuriganaSegment(term, '')];
    }

    const groups = [];
    let groupPre = null;
    let isKanaPre = null;
    for (const c of term) {
        const codePoint = c.codePointAt(0);
        const isKana = isCodePointKana(codePoint);
        if (isKana === isKanaPre) {
            groupPre.text += c;
        } else {
            groupPre = { isKana, text: c, textNormalized: null };
            groups.push(groupPre);
            isKanaPre = isKana;
        }
    }
    for (const group of groups) {
        if (group.isKana) {
            group.textNormalized = convertKatakanaToHiragana(group.text);
        }
    }

    const readingNormalized = convertKatakanaToHiragana(reading);
    const segments = segmentizeFurigana(reading, readingNormalized, groups, 0);
    if (segments !== null) {
        return segments;
    }

    // Fallback
    return [createFuriganaSegment(term, reading)];
}

//// YOMICHAN END ////

function parseSyntax(text) {
    let ret = [];

    // without workarounds for missing spaces: /{([^]*?)}|((\S*)\[(.*?)\](\S*))|([^ {]+)/gm
    const syntax_re = new RegExp(/{([^]*?)}|(([\S　]*)\[(.*?)\](\S*))|([^ \u00A0{]+)/gm);

    const ja_text_re = new RegExp(/[\u3041-\u3096\u30A0-\u30FF\u3400-\u4DB5\u4E00-\u9FCB\uF900-\uFA6A\u2E80-\u2FD5\uFF65-\uFF9F\々]/m);

    var match;
    do {
        match = syntax_re.exec(text);
        if (match) {
            // raw segment in curly braces
            if (match[1]) {
                ret.push({
                    type: 'raw',
                    text: match[1]
                });
            }
            // syntax segment
            if (match[2]) {
                const braket_parts = match[4].split(';');

                const first_parts = braket_parts[0].split(',');

                const reading = first_parts[0] || '';
                const dict_form = first_parts[1] || '';

                const pitch_accent_parts = braket_parts[1] || '';
                const pitch_accents = pitch_accent_parts.split(',');

                const pre_text_match = match[3];

                let i = pre_text_match.length;
                while (i > 0) {
                    if (!ja_text_re.test(pre_text_match[i-1])) {
                        break;
                    }
                    i--;
                }

                if (i > 0) {
                    ret.push({
                        type: 'plain',
                        text: pre_text_match.substring(0, i)
                    });
                }

                const pre_text = pre_text_match.substring(i);

                ret.push({
                    type: 'syntax',
                    word_pre: pre_text,
                    word_post: match[5],
                    reading: reading,
                    dict_form: dict_form,
                    pitch_accents: pitch_accents
                });
            }
            // plain segment
            else if (match[6]) {
                ret.push({
                    type: 'plain',
                    text: match[6]
                });
            }
        }
    } while (match);

    return ret;
}

function pitchGraphElement(text, start, end, drop) {
    const ret = document.createElement('span');
    ret.classList.add('pitch-container');

    ret.appendChild(document.createTextNode(text.substring(0, start)));

    const pitch_box = document.createElement('span');
    pitch_box.classList.add('pitch-box');
    ret.appendChild(pitch_box);

    const overbar = document.createElement('span');
    overbar.classList.add('pitch-overbar');
    pitch_box.appendChild(overbar);

    pitch_box.appendChild(document.createTextNode(text.substring(start, end)));

    if (drop) {
        const overbar = document.createElement('span');
        overbar.classList.add('pitch-drop');
        pitch_box.appendChild(overbar);
    }

    ret.appendChild(document.createTextNode(text.substring(end)));

    return ret;
}

function syllablePos(text, idx) {
    if (idx == 0) {
        return 0;
    }

    if (idx < 0) {
        return text.length - syllablePos(text.split('').reverse().join(''), -idx, false);
    }

    let count = 0;

    for (let i = 0; i < text.length; i++) {
        if ('ゃょゅぁぃぇぉぅャョュァィェォゥ'.indexOf(text[i]) < 0) {
            count++;
            if (idx == count) {
                return i + 1;
            }
        }
    }

    return null;
}

function parsePitches(pitch_text) {
    const pitches = [];

    for (c of pitch_text) {
        if ((/[a-zA-Z]/).test(c)) {
            pitches.push(c);
        }
        else if (pitches.length) {
            pitches[pitches.length-1] += c;
        }
    }

    return pitches;
}

function pitchClasses(pitch_text, hover) {
    const pitches = parsePitches(pitch_text);
    const pitch_classes = [];

    if (pitches.length >= 1) {
        const pre_class = hover ? 'pitch-hover-' : 'pitch-';
        pitch_classes.push(pre_class + pitches[0][0]);
    }
    if (pitches.length >= 2) {
        const pre_class = hover ? 'pitch-bg-hover-' : 'pitch-bg-';
        pitch_classes.push(pre_class + pitches[1][0]);
    }

    return pitch_classes;
}


function syntaxElementToNode(syntax_element, field_settings) {
    if (syntax_element.type !== 'syntax') {
        return document.createTextNode(syntax_element.text);
    }
    else {
        const node = document.createElement('span');
        node.classList.add('word');

        const audio_play_word = syntax_element.word_pre + syntax_element.word_post;
        node.addEventListener('click', function() {
            pycmd('play_audio-' + audio_play_word);
        });

        if (field_settings.furigana === 'hidden') {
            node.classList.add('furigana-invisible');
        }
        else if (field_settings.furigana === 'hover' && !field.popup) {
            node.classList.add('furigana-hover');
        }

        const text_content = document.createElement('span');
        node.appendChild(text_content);

        if (field_settings.pitch_coloring !== 'no' && syntax_element.pitch_accents.length) {
            const pitch_classes = pitchClasses(syntax_element.pitch_accents[0], field_settings.pitch_coloring === 'hover');
            for (let c of pitch_classes) {
                text_content.classList.add(c);
            }
        }

        const segments = distributeFurigana(syntax_element.word_pre, syntax_element.reading)

        if (field_settings.furigana !== 'no' && (segments.length > 1 || segments[0].reading)) {
            const ruby_elem = document.createElement('ruby');
            text_content.appendChild(ruby_elem);

            for (const segment of segments) {
                ruby_elem.appendChild(document.createTextNode(segment.text));

                const rt_elem = document.createElement('rt');
                rt_elem.textContent = segment.reading;
                ruby_elem.appendChild(rt_elem);
            }

            if (syntax_element.word_post) {
                ruby_elem.appendChild(document.createTextNode(syntax_element.word_post));
            }
        }
        else {
            text_content.textContent = syntax_element.word_pre + syntax_element.word_post;
        }

        if (field_settings.pitch_shapes !== 'no') {
            if (field_settings.pitch_shapes === 'hover') {
                node.classList.add('pitch-shape-hover');
            }

            for (let i = 1; i < syntax_element.pitch_accents.length; i++) {
                const pitch_accents = parsePitches(syntax_element.pitch_accents[i]);

                if (pitch_accents.length == 1) {
                    const diamond = document.createElement('span');
                    diamond.classList.add('pitch-diamond');
                    diamond.classList.add('pitch-bg-' + pitch_accents[0][0]);
                    node.appendChild(diamond);
                }
                else if (pitch_accents.length == 2) {
                    const circle_l = document.createElement('span');
                    circle_l.classList.add('pitch-circle-left');
                    circle_l.classList.add('pitch-bg-' + pitch_accents[0][0]);
                    node.appendChild(circle_l);

                    const circle_r = document.createElement('span');
                    circle_r.classList.add('pitch-circle-right');
                    circle_r.classList.add('pitch-bg-' + pitch_accents[1][0]);
                    node.appendChild(circle_r);
                }
            }
        }

        if (field_settings.popup === 'yes') {
            const popup_text = syntax_element.dict_form || ((syntax_element.reading || syntax_element.word_pre) + syntax_element.word_post);

            if (popup_text) {
                const popup_hover_box = document.createElement('div');
                popup_hover_box.classList.add('popup-hover-box');
                node.appendChild(popup_hover_box);

                const popup_container = document.createElement('div');
                popup_container.classList.add('popup');
                node.appendChild(popup_container);

                const popup_text_hiragana = convertKatakanaToHiragana(popup_text);

                for (const pitch_accent of syntax_element.pitch_accents) {
                    const pitch_classes = pitchClasses(pitch_accent);

                    const popup_content_part = document.createElement('div');
                    popup_content_part.classList.add('pitch-graph');
                    popup_container.appendChild(popup_content_part);

                    if (pitch_classes.length == 1) {
                        let start, end, drop;

                        if (pitch_accent[0] === 'h') {
                            start = 1;
                            end = null;
                            drop = false;
                        }
                        else if (pitch_accent[0] === 'a') {
                            start = 0;
                            end = 1;
                            drop = true;
                        }
                        else if (pitch_accent[0] === 'n') {
                            start = 1;
                            end = parseInt(pitch_accent.substring(1));
                            drop = true;
                        }
                        else if (pitch_accent[0] === 'o') {
                            start = -1;
                            end = null;
                            drop = true;
                        }
                        else if (pitch_accent[0] === 'k') {
                            start = 1;
                            end = parseInt(pitch_accent.substring(1));
                            drop = true;
                        }

                        let start_pos = syllablePos(popup_text_hiragana, start);
                        let end_pos = end === null ? popup_text_hiragana.length : syllablePos(popup_text_hiragana, end);

                        if (start_pos !== null && end_pos !== null && start_pos < end_pos) {
                            const pitch_graph = pitchGraphElement(popup_text_hiragana, start_pos, end_pos, drop);
                            popup_content_part.appendChild(pitch_graph);
                        }
                        else {
                            popup_content_part.textContent = popup_text_hiragana;
                        }
                    }
                    else {
                        popup_content_part.textContent = popup_text_hiragana;
                    }

                    for (c of pitch_classes) {
                        popup_content_part.classList.add(c);
                    }
                }

                if (popup_container.childNodes.length == 0) {
                    popup_container.textContent = popup_text_hiragana;
                }
            }
        }

        return node;
    }
}

function syntaxToNodes(syntax, field_settings) {
    return syntax.map(function (syntax_element) {
        return syntaxElementToNode(syntax_element, field_settings);
    });
}

function handleFieldTextNodes(node, field_settings, in_curly={ value: false }) {
    if (node.nodeType == Node.TEXT_NODE) {
        let text = node.textContent;

        // Handle curly braces spanning across tags (ugly, ugly, ugly)
        if (in_curly.value) {
            text = '{' + text;
        }
        for (let i = text.length-1; i >= 0; i--) {
            if (text[i] == '}') {
                in_curly.value = false;
                break
            }
            else if (text[i] == '{') {
                in_curly.value = true;
                break
            }
        }
        if (in_curly.value) {
            text = text + '}';
        }

        const syntax = parseSyntax(text);
        const nodes = syntaxToNodes(syntax, field_settings);

        const replacement_node = document.createElement('span');
        node.parentNode.insertBefore(replacement_node, node);
        for (const child of nodes) {
            replacement_node.appendChild(child);
        }
        node.parentNode.removeChild(node);
    }
    else {
        for (let i =  0; i < node.childNodes.length; i++) {
            handleFieldTextNodes(node.childNodes[i], field_settings, in_curly);
        }
    }
}

function handleField(field) {
    // Ignore field if it doesn't contain syntax
    const syntax_test_re = /[\{\}\[\]]/;
    if (!syntax_test_re.test(field.textContent)) {
        return;
    }

    const field_settings = {
        popup: field.getAttribute('data-popup') || 'no',
        pitch_coloring: field.getAttribute('data-pitch-coloring') || 'no',
        pitch_shapes: field.getAttribute('data-pitch-shapes') || 'no',
        furigana: field.getAttribute('data-furigana') || 'no'
    };

    if (field_settings.popup === 'yes' && field_settings.furigana === 'hover') {
        field_settings.furigana = 'hidden';
    }

    handleFieldTextNodes(field, field_settings);
}


const fields = document.querySelectorAll('.field');

for (field of fields) {
    handleField(field);
}


function closeAllActive() {
    const current_popups = document.querySelectorAll('.active');
    for (const popup of current_popups) {
        popup.classList.remove('active', 'popup-active');
    }
    return current_popups.length > 0;
}

function on_closeAllActiveBody(event) {
    if (!event.target.closest('.word')) {
        if (closeAllActive()) {
            event.preventDefault();
        }
    }
}

function activeEnablePopup(elem) {
    const popup_elem = elem.querySelector('.popup');
    if (!popup_elem) {
        return
    }

    elem.classList.add('popup-active');

    function isTooHigh() {
        return popup_elem.getBoundingClientRect().top < 0
    }

    function isTooLow() {
        return popup_elem.getBoundingClientRect().bottom >= (window.innerHeight || document.documentElement.clientHeight)
    }

    function isTooRight() {
        return popup_elem.getBoundingClientRect().right >= (window.innerWidth || document.documentElement.clientWidth)
    }

    function isTooLeft() {
        return popup_elem.getBoundingClientRect().left < 0
    }

    elem.classList.remove('popup-direction-u', 'popup-direction-d', 'popup-direction-l', 'popup-direction-r');

    elem.classList.add('popup-direction-u');
    if (!isTooHigh()) {
        return;
    }
    elem.classList.remove('popup-direction-u');

    elem.classList.add('popup-direction-d');
    if (!isTooLow()) {
        return;
    }
    elem.classList.remove('popup-direction-d');

    elem.classList.add('popup-direction-l');
    if (!isTooLeft()) {
        return;
    }
    elem.classList.remove('popup-direction-l');

    elem.classList.add('popup-direction-r');
    if (!isTooRight()) {
        return;
    }
    elem.classList.remove('popup-direction-r');

    elem.classList.add('popup-direction-u');
}

function on_activeEnter(event) {
    if (event) {
        event.preventDefault();
    }

    closeAllActive();
    this.classList.add('active');
    activeEnablePopup(this);
}

function on_activeLeave() {
    this.classList.remove('active', 'popup-active');
}

const word_elements = document.querySelectorAll('.word');
const is_mobile = typeof(pycmd) === typeof(undefined);

for (elem of word_elements) {
    elem.addEventListener('mouseenter', on_activeEnter);
    elem.addEventListener('ontouchend', on_activeEnter);
    if (!is_mobile) {
        elem.addEventListener('mouseleave', on_activeLeave);
    }
}

if (is_mobile) {
    document.body.addEventListener('click', on_closeAllActiveBody);
}

}());
</script>
<!--###MIGAKU JAPANESE SUPPORT JS ENDS###-->